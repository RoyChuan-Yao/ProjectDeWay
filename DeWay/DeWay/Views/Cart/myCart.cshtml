@model IEnumerable<DeWay.Models.Cart_OrderDetail>

@{
    ViewBag.Title = "我的購物車";
}

<h2 class="mb-3" id="cart_title">@Html.DisplayFor(m => m.ToList()[0].Member.mbrName)的購物車</h2>
<div class="row">
    <div class="col-8">
        @Html.Partial("_CartCard", Model)
    </div>
    <div class="col-4">
        <div class="sticky-top">
            <div class="card ">
                <div class="card-header">
                    訂單摘要
                </div>
                <div class="card-body">
                    <p class="card-text">商品總計：<span id="priceTotal">NT$ 0</span></p>
                    <p class="card-text">運費總計：<span id="shpTotal">NT$ 0</span></p>
                    <a href="">使用優惠券、紅利或禮物卡</a>
                    <hr />
                    <button id="checkOutBtn" class="btn btn-warning btn-block" onclick="checkOut()" disabled>前往結帳</button>
                </div>
            </div>
            <div class="card mt-2">
                <button class="btn btn-info" data-toggle="modal" data-target="#exampleModalCenter">請填寫收件人與購買人資料</button>
                <form action="/" method="post">
                    <div class="card-header">
                        收件資訊
                    </div>
                    <div class="card-body">
                        <p class="card-text">@*<button class="btn btn-info" data-toggle="modal" data-target="#exampleModalCenter">請填寫收件人與購買人資料</button>*@</p>
                        <label for="shipSelect">運送方式</label>

                        <label for="">給設計師的信息或注意事項</label>
                        <textarea id="note" value="" placeholder="給設計師的信息或注意事項" class="form-control" cols="2" rows="2" ></textarea>
                        <hr />
                        <button id="checkOutBtn" class="btn btn-warning m-2 " onclick="checkOut()" disabled>前往結帳</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!--Modal-->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">收件人與購買資料</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                
                <form action="/" method="">
                    <div class="form-group">
                        @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recName, new { @class = "control-label col-md-2" })
                        <div class="col-md-10">
                            @Html.EditorFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recName, new { @class = "form-control " })
                        </div>
                    </div>
                    <div class="form-group">
                        @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recPhone, new { @class = "control-label col-md-2" })
                        <div class="col-md-10">
                            @Html.EditorFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recPhone, new { @class = "form-control " })
                        </div>
                    </div>
                    <div class="form-group ">
                        @Html.Label("商品寄往", new { @class = "control-label col-12 h5" })
                    </div>
                        <div class="form-group">
                            @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recCity, new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.EditorFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recCity, new { @class = "form-control " })
                            </div>
                        </div>
                        <div class="form-group">
                            @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recDist, new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.EditorFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recDist, new { @class = "form-control " })
                            </div>
                        </div>
                    <div class="form-group">
                            @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recAdress, new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.EditorFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recAdress, new { @class = "form-control " })
                            </div>
                        </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>
<!--Modal-->

@using (Html.BeginForm("receiveOrder", "Cart"))
{

}
@section cartScript{

    <script>
        var len = $("input[type='checkbox']").length//檢查讀取了幾個商品項目

        //利用陣列存取誰被點選
        var checkStatus = [];
        for (var i = 0; i < len; i++) { //初始化陣列(預設0個商品被勾選)
            checkStatus.push(false);
        }

        //點選其中一個商品後，改變checkStatus
        function changeChckeStatus(arr, index) {
            arr[index] = !arr[index];
            updateTotalPrice(arr);//點選後更新訂單摘要
            //改變結帳按鈕狀態
            if (arr.indexOf(true) == -1) {
                $("#checkOutBtn").attr("disabled", "disabled")
            } else {
                $("#checkOutBtn").removeAttr("disabled")
            }
        }

        //更新訂單摘要
        function updateTotalPrice(arr) {
            var price, count, totalPrice = 0;
            for (i = 0; i < arr.length; i++) {
                if (arr[i] == true) {
                    //獲取被點選商品的價格與數量
                    price = parseInt($("#price_" + i).text());
                    count = parseInt($("#count_" + i).text());
                    //相乘後計算總價
                    totalPrice += price * count;
                }
            }
            //在欄位顯示總價
            $("#priceTotal").text("NT$ " + totalPrice);
        }
    </script>
    <script>
        $("#backToCart").hide()//從結帳畫面改回購物車

        //反回購物車列表
        function backToCart() {
            $("div[id^='no']").show(100)
            $("#backToCart").hide(100);//隱藏按鈕
            $("#checkOutBtn").text("前往結帳").attr("onclick", "checkOut()")
            $("input[type='checkbox'],a[href*='Delete']").show(100)
            $("form").html('')
        }

        //前往結帳
        function checkOut() {//鎖定購物車，頁面改成結帳頁面
            if ($("#backToCart").length == 0) {//加入回購物車按鈕
                $(`<button class="btn btn-dark mb-2" onclick="backToCart()" id="backToCart">&lt&lt返回購物車</button>`).insertAfter("#cart_title")
            }
            checkStatus.forEach((value, index) => {//隱藏為false的按鈕
                if (value == false) {
                    $(`#no_${index}`).hide(250);
                }
            })
            $("input[type='checkbox'],a[href*='Delete']").hide(100)
            $("#backToCart").show(100)
            $("#checkOutBtn").text("確認付款").attr("onclick", "submitOrder()")
        }

        //提交訂單
        function submitOrder() {
            //產生Form內容
            var result = {}

            for (i = 0; i <= len; i++) {
                if (checkStatus[i]) {
                    result += `<input type="hidden" name="cartID" value="${i}">`
                }
            }
            $("form").html(result)
            $("form").submit();
        }

    </script>
}

