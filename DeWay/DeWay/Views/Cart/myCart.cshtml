@model IEnumerable<DeWay.Models.Cart_OrderDetail>

@{
    ViewBag.Title = "我的購物車";
}
@*TODO: 後端驗證阻擋：收件人地址*@
<h2 class="mb-3" id="cart_title">@Html.Raw(ViewBag.memberName)的購物車</h2>
<div class="row">
    <div class="col-8">
        @Html.Partial("_CartCard", Model)
    </div>
    <div class="col-4">
        <div class="sticky-top">
            <div class="card ">
                <div class="card-header">
                    訂單摘要
                </div>
                <div class="card-body">
                    <p class="card-text">商品總計：<span id="priceTotal">NT$ 0</span></p>
                    <p class="card-text">運費總計：<span id="shpTotal">NT$ 0</span></p>
                    <a href="">使用優惠券、紅利或禮物卡</a>
                    <hr />
                    <button id="checkOutBtn" class="btn btn-warning btn-block" onclick="checkOut()" disabled>前往結帳</button>
                </div>
            </div>
            <div id="receiverInfo" class="card mt-2" style="display: none">
                <div class="card-header">
                    收件資訊
                </div>
                <div class="card-body">
                    <button class="btn btn-info btn-block" data-toggle="modal" data-target="#exampleModalCenter">請填寫收件人與購買人資料</button>
                    <p id="receiverBoard" class="card-text"></p>
                    <label for="">給設計師的訊息或注意事項</label>
                    <textarea id="note" value="" placeholder="給設計師的訊息或注意事項" class="form-control" cols="2" rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>
<!--Modal-->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">收件人與購買資料</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="form-group">
                    @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recName, new { @class = "control-label col-12" })
                    <div class="col-md-10">
                        @Html.Editor("recName", new { @class = "form-control " })
                    </div>
                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recPhone, new { @class = "control-label col-12" })
                    <div class="col-md-10">
                        @Html.Editor("recPhone", new { @class = "form-control " })
                    </div>
                </div>
                <div class="form-group ">
                    @Html.Label("商品寄往", new { @class = "control-label col-12 h5" })
                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recCity, new { @class = "control-label col-12" })
                    <div class="col-md-10">
                        @Html.Editor("recCity", new { @class = "form-control " })
                    </div>
                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recDist, new { @class = "control-label col-12" })
                    <div class="col-md-10">
                        @Html.Editor("recDist", new { @class = "form-control " })
                    </div>
                </div>
                <div class="form-group">
                    @Html.LabelFor(m => m.FirstOrDefault().Member.Review.FirstOrDefault().Order.recAddress, new { @class = "control-label col-12" })
                    <div class="col-md-10">
                        @Html.Editor("recAddress", new { @class = "form-control " })
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button id="updateAddress" type="button" class="btn btn-primary" onclick="updateAddressToForm()" data-dismiss="modal">Save changes</button>
            </div>
        </div>
    </div>
</div>
<!--Modal-->
@using (Html.BeginForm("receiveOrder", "Cart"))
{

}
@section Script{
    <script>
        function updateAddressToForm() {//顯示收件人資料
            var displayAddress = "";
            $(`div[class="modal-content"] input`).each((i,e) => {
                displayAddress += `<p>${$(e).parent().prev().text()}:${$(e).val()}</p>`;
            });
            $(`#receiverBoard`).html(displayAddress);
        }
    </script>
    <script>
        var len = $("input[type='checkbox']").length//檢查讀取了幾個商品項目

        var checkStatus = []; //利用陣列存取誰被點選
        for (var i = 0; i < len; i++) { //初始化陣列(預設0個商品被勾選)
            checkStatus.push(false);
        }

        //點選其中一個商品後，改變checkStatus
        function changeChckeStatus(arr, index) {
            arr[index] = !arr[index];
            updateTotalPrice(arr);//點選後更新訂單摘要
            //改變結帳按鈕狀態
            if (arr.indexOf(true) == -1) {
                $("#checkOutBtn").attr("disabled", "disabled")
            } else {
                $("#checkOutBtn").removeAttr("disabled")
            }
        }

        //更新訂單摘要
        function updateTotalPrice(arr) {
            var price, count, totalPrice = 0;
            for (i = 0; i < arr.length; i++) {
                if (arr[i] == true) {
                    //獲取被點選商品的價格與數量
                    price = parseInt($("#price_" + i).text());
                    count = parseInt($("#count_" + i).text());
                    //相乘後計算總價
                    totalPrice += price * count;
                }
            }
            //在欄位顯示總價
            $("#priceTotal").text("NT$ " + totalPrice);
        }
    </script>
    <script>
        $("#backToCart").hide()//從結帳畫面改回購物車畫面

        var title = $(`#cart_title`).text()
        //反回購物車列表
        function backToCart() {
            $(`div[class='card mb-3']`).show()
            $("div[id^='no']").show(100)
            $("#backToCart").hide(100);//隱藏按鈕
            $("#checkOutBtn").text("前往結帳").attr("onclick", "checkOut()")
            $("input[type='checkbox'],a[href*='Delete']").show(100)
            $("form").html('')
            $(`#receiverInfo`).hide(100)
            $(`#cart_title`).text(title)
        }

        //前往結帳
        function checkOut() {//鎖定購物車，頁面改成結帳頁面
            if ($("#backToCart").length == 0) {//加入回購物車按鈕
                $(`<button class="btn btn-dark mb-2" onclick="backToCart()" id="backToCart">&lt&lt返回購物車</button>`).insertAfter("#cart_title")
            }
            $(`div[class='card mb-3']`).hide()
            $(`div[class*='no']`).hide()
            checkStatus.forEach((value, index) => {//顯示為false的按鈕
                if (value == true) {
                    //$(`#no_${index}`).show().parent().show();
                    $(`#no_${index}`).show().parent().show();
                }
            })
            $("input[type='checkbox'],a[href*='Delete']").hide(100)
            $("#backToCart").show(100)
            $("#checkOutBtn").text("確認付款").attr("onclick", "submitOrder()")
            $(`#receiverInfo`).show(100)
            $(`#cart_title`).text("填寫地址與付款")
        }

        //提交訂單
        function submitOrder() {
            var cartResult = "";
            for (i = 0; i <= len; i++) {//取得被點選的商品編號
                cartResult += `<input type="" name="cartID[${i}]" value="${checkStatus[i] ? $('.cartID')[i].innerText : false}">`;
                console.log($('#shipSelect_' + i + ' option:selected'));
                cartResult += `<input type="" name="shipSelect[${i}]" value="${$('#shipSelect_' + i + ' option:selected').text()}">`;
            }

            var reciverFormResult = "";//取得收寄人資料做成表單內容
            $(`div[class="modal-content"] input`).each((index, e) => {
                reciverFormResult += `<input type="" name="${$(e).attr('name')}" value="${$(e).val()}">`;
            })

            var note = `<input type="" name="odrNote" value="${$('#note').val()}">`//取得給賣家的註解
            var finalResult = cartResult + reciverFormResult + note;
            $("form").html(finalResult)//將被點選商品加入表單
            $("form").submit();//提交表單
        }

    </script>

}

